"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const prifile_1 = require("../../service/prifile");
const rental_pb_1 = require("../../service/proto_gen/rental/rental_pb");
const trip_1 = require("../../service/trip");
const format_1 = require("../../utils/format");
const routing_1 = require("../../utils/routing");
const TripsStatusMap = new Map([
    [rental_pb_1.rental.v1.TripStatus.IN_PROGRESS, '进行中'],
    [rental_pb_1.rental.v1.TripStatus.FINISHED, '已完成'],
]);
const ProfileStatusMap = new Map([
    [rental_pb_1.rental.v1.IdentityStatus.UNSUBMITTED, '未认证'],
    [rental_pb_1.rental.v1.IdentityStatus.PENDING, '认证中'],
    [rental_pb_1.rental.v1.IdentityStatus.VERIFIED, '已认证'],
]);
Page({
    scrollStates: {
        mainItem: [],
    },
    layoutResolver: undefined,
    data: {
        licStatus: ProfileStatusMap.get(rental_pb_1.rental.v1.IdentityStatus.UNSUBMITTED),
        tripsHeight: 0,
        avatarURL: '',
        trips: [],
        mainitem: [],
        navitem: [],
        mainscroll: '',
        navCount: 0,
        navSelect: '',
        navScroll: "x",
        promotionItems: [
            {
                img: 'https://img1.baidu.com/it/u=590110346,433709782&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=222',
                promotionId: 0,
            },
            {
                img: 'http://img.mp.itc.cn/upload/20160421/facaa82b67c342a78dc2e2f1f20c6381_th.jpg',
                promotionId: 1,
            },
            {
                img: 'https://m1.auto.itc.cn/c_zoom,w_270/29762096.JPG',
                promotionId: 3,
            },
            {
                img: 'http://t13.baidu.com/it/u=2792884273,1681992034&fm=224&app=112&f=JPEG?w=500&h=253',
                promotionId: 4,
            },
            {
                img: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fdefaxingzheng.com%2FPublic%2Fuploads%2F5bea893335400.jpg&refer=http%3A%2F%2Fdefaxingzheng.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1651671705&t=2cd5538942becbf53365b23807300bdc',
                promotionId: 5,
            }
        ]
    },
    onLoad() {
        const layoutReady = new Promise((resolve) => {
            this.layoutResolver = resolve;
        });
        Promise.all([trip_1.TripService.getTrips(), layoutReady]).then(([trips]) => {
            console.log("trips:", trips);
            this.populateTrips(trips.trips);
        });
        getApp().globalData.userInfo.then(userInfo => {
            this.setData({
                avatarURL: userInfo.avatarUrl,
            });
        });
    },
    onShow() {
        prifile_1.ProfileService.getProfile().then(p => {
            this.setData({
                licStatus: ProfileStatusMap.get(p.identityStatus || 0),
            });
        });
    },
    onReady() {
        wx.createSelectorQuery().select('#heading')
            .boundingClientRect(rect => {
            const height = wx.getSystemInfoSync().windowHeight - rect.height;
            this.setData({
                tripsHeight: height,
                navCount: Math.round(height / 50),
            }, () => {
                if (this.layoutResolver) {
                    this.layoutResolver(rect);
                }
            });
        }).exec();
    },
    populateTrips(trips) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j;
        const mainItem = [];
        const navItem = [];
        let navSelect = '';
        let prevNav = '';
        for (let i = 0; i < trips.length; i++) {
            const trip = trips[i];
            const mainId = 'main-' + i;
            const navId = 'nav-' + i;
            const shortId = (_a = trip.id) === null || _a === void 0 ? void 0 : _a.substring(trip.id.length - 6);
            if (!prevNav) {
                prevNav = navId;
            }
            const tripDate = {
                id: trip.id,
                shortId: '*****' + shortId,
                statar: ((_c = (_b = trip.trip) === null || _b === void 0 ? void 0 : _b.start) === null || _c === void 0 ? void 0 : _c.poiName) || '未知',
                end: '',
                duration: '',
                fee: '',
                distance: '',
                stutar: TripsStatusMap.get((_d = trip.trip) === null || _d === void 0 ? void 0 : _d.status) || '未知',
                inProgress: ((_e = trip.trip) === null || _e === void 0 ? void 0 : _e.status) === rental_pb_1.rental.v1.TripStatus.IN_PROGRESS,
            };
            const end = (_f = trip.trip) === null || _f === void 0 ? void 0 : _f.end;
            if (end) {
                tripDate.end = end.poiName || '未知';
                tripDate.distance = ((_g = end.kmDriven) === null || _g === void 0 ? void 0 : _g.toFixed(1)) + '公里';
                tripDate.fee = format_1.formatfee(end.feeCent || 0);
                const dur = format_1.formatDurtion((end.timestampSec || 0) - (((_j = (_h = trip.trip) === null || _h === void 0 ? void 0 : _h.start) === null || _j === void 0 ? void 0 : _j.timestampSec) || 0));
                tripDate.duration = `${dur.hh}时:${dur.mm}分:${dur.ss}秒`;
            }
            mainItem.push({
                id: mainId,
                navId: navId,
                navScrollId: prevNav,
                data: tripDate,
            });
            navItem.push({
                id: navId,
                mainId: mainId,
                label: shortId || '',
            });
            if (i === 0) {
                navSelect = navId;
            }
            prevNav = navId;
            for (let i = 0; i < this.data.navCount - 8; i++) {
                navItem.push({
                    id: '',
                    mainId: '',
                    label: '',
                });
            }
        }
        this.setData({
            mainItem,
            navItem,
            navSelect
        }, () => {
            this.prepareScroll();
        });
    },
    getchangePage() {
        wx.navigateTo({
            url: routing_1.routing.register(),
        });
    },
    onGetUserInfo(e) {
        console.log(e);
        const userInfo = e.detail.userInfo;
        getApp().resolveUserInfo(userInfo);
    },
    prepareScroll() {
        wx.createSelectorQuery().selectAll('.main-item').fields({
            id: true,
            dataset: true,
            rect: true,
        }).exec(res => {
            this.scrollStates.mainItem = res[0];
        });
    },
    onPromotionItemTap(e) {
        const promotionID = e.currentTarget.dataset.promotionId;
        if (promotionID) {
            console.log('claiming promotion', promotionID);
        }
    },
    onnavitemTap(e) {
        var _a, _b;
        const mainId = (_a = e.currentTarget) === null || _a === void 0 ? void 0 : _a.dataset.mainId;
        const navId = (_b = e.currentTarget) === null || _b === void 0 ? void 0 : _b.id;
        if (mainId && navId) {
            this.setData({
                mainscroll: mainId,
                navSelect: navId,
            });
        }
    },
    onMainScroll(e) {
        var _a, _b;
        console.log(e);
        const top = ((_a = e.currentTarget) === null || _a === void 0 ? void 0 : _a.offsetTop) + ((_b = e.detail) === null || _b === void 0 ? void 0 : _b.scrollTop);
        if (top === undefined) {
            return;
        }
        const selItem = this.scrollStates.mainItem.find(Item => Item.top >= top);
        if (!selItem) {
            return;
        }
        this.setData({
            navSelect: selItem.dataset.navId,
            navScroll: selItem.dataset.navScrollId,
        });
    },
    onMianItemTap(e) {
        if (!e.currentTarget.dataset.tripInProgress) {
            console.log("拿不到:", e);
            return;
        }
        const tripId = e.currentTarget.dataset.tripId;
        if (tripId) {
            console.log(tripId);
            wx.navigateTo({
                url: routing_1.routing.driving({
                    trip_id: tripId,
                }),
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXl0cmlwcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm15dHJpcHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSxtREFBc0Q7QUFDdEQsd0VBQWlFO0FBQ2pFLDZDQUFnRDtBQUNoRCwrQ0FBNkQ7QUFDN0QsaURBQTZDO0FBYzdDLE1BQU0sY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDO0lBQzNCLENBQUMsa0JBQU0sQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUM7SUFDekMsQ0FBQyxrQkFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQztDQUN6QyxDQUFDLENBQUE7QUFFRixNQUFNLGdCQUFnQixHQUFHLElBQUksR0FBRyxDQUFDO0lBQzdCLENBQUMsa0JBQU0sQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUM7SUFDN0MsQ0FBQyxrQkFBTSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQztJQUN6QyxDQUFDLGtCQUFNLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDO0NBQzdDLENBQUMsQ0FBQTtBQXdCRixJQUFJLENBQUM7SUFDRCxZQUFZLEVBQUM7UUFDVCxRQUFRLEVBQUUsRUFBNEI7S0FDekM7SUFDRCxjQUFjLEVBQUMsU0FBK0M7SUFHOUQsSUFBSSxFQUFDO1FBQ0QsU0FBUyxFQUFFLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxrQkFBTSxDQUFDLEVBQUUsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDO1FBQ3JFLFdBQVcsRUFBQyxDQUFDO1FBQ2IsU0FBUyxFQUFDLEVBQUU7UUFDWixLQUFLLEVBQUMsRUFBWTtRQUNsQixRQUFRLEVBQUUsRUFBZ0I7UUFDMUIsT0FBTyxFQUFFLEVBQWU7UUFDeEIsVUFBVSxFQUFFLEVBQUU7UUFDZCxRQUFRLEVBQUMsQ0FBQztRQUNW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QUFDO2dCQUNWLEdBQUcsRUFBRSxpQkFBTyxDQUFDLE9BQU8sQ0FBQztvQkFDakIsT0FBTyxFQUFFLE1BQU07aUJBQ2xCLENBQUM7YUFDTCxDQUFDLENBQUE7U0FDTDtJQUNMLENBQUM7Q0FDSixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJQXBwT3B0aW9uIH0gZnJvbSBcIi4uLy4uL2FwcG9wdGlvblwiXG5pbXBvcnQgeyBQcm9maWxlU2VydmljZSB9IGZyb20gXCIuLi8uLi9zZXJ2aWNlL3ByaWZpbGVcIlxuaW1wb3J0IHsgcmVudGFsIH0gZnJvbSBcIi4uLy4uL3NlcnZpY2UvcHJvdG9fZ2VuL3JlbnRhbC9yZW50YWxfcGJcIlxuaW1wb3J0IHsgVHJpcFNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vc2VydmljZS90cmlwXCJcbmltcG9ydCB7IGZvcm1hdER1cnRpb24sIGZvcm1hdGZlZSB9IGZyb20gXCIuLi8uLi91dGlscy9mb3JtYXRcIlxuaW1wb3J0IHsgcm91dGluZyB9IGZyb20gXCIuLi8uLi91dGlscy9yb3V0aW5nXCJcblxuaW50ZXJmYWNlIFRyaXB7XG4gICAgaWQ6IHN0cmluZyxcbiAgICBzaG9ydElkOiBzdHJpbmcsXG4gICAgc3RhdGFyOiBzdHJpbmcsXG4gICAgZW5kOnN0cmluZyxcbiAgICBkdXJhdGlvbjogc3RyaW5nLFxuICAgIGZlZTogc3RyaW5nLFxuICAgIGRpc3RhbmNlOiBzdHJpbmcsXG4gICAgc3R1dGFyOnN0cmluZyxcbiAgICBpblByb2dyZXNzOiBib29sZWFuLFxufVxuXG5jb25zdCBUcmlwc1N0YXR1c01hcCA9IG5ldyBNYXAoW1xuICAgIFtyZW50YWwudjEuVHJpcFN0YXR1cy5JTl9QUk9HUkVTUywgJ+i/m+ihjOS4rSddLFxuICAgIFtyZW50YWwudjEuVHJpcFN0YXR1cy5GSU5JU0hFRCwgJ+W3suWujOaIkCddLFxuXSlcblxuY29uc3QgUHJvZmlsZVN0YXR1c01hcCA9IG5ldyBNYXAoW1xuICAgIFtyZW50YWwudjEuSWRlbnRpdHlTdGF0dXMuVU5TVUJNSVRURUQsICfmnKrorqTor4EnXSxcbiAgICBbcmVudGFsLnYxLklkZW50aXR5U3RhdHVzLlBFTkRJTkcsICforqTor4HkuK0nXSxcbiAgICBbcmVudGFsLnYxLklkZW50aXR5U3RhdHVzLlZFUklGSUVELCAn5bey6K6k6K+BJ10sXG5dKVxuXG5pbnRlcmZhY2UgTWFpbkl0ZW17XG4gICAgaWQ6IHN0cmluZyxcbiAgICBuYXZJZDogc3RyaW5nLFxuICAgIG5hdlNjcm9sbElkOiBzdHJpbmcsXG4gICAgZGF0YTogVHJpcCxcbn1cblxuaW50ZXJmYWNlIE5hdkl0bWV7XG4gICAgaWQ6IHN0cmluZyxcbiAgICBtYWluSWQ6IHN0cmluZyxcbiAgICBsYWJlbDogc3RyaW5nLFxufVxuXG5pbnRlcmZhY2UgTWFpbkl0ZW1RdWVyeVJlc3VsdHN7XG4gICAgaWQ6IHN0cmluZyxcbiAgICB0b3A6IG51bWJlcixcbiAgICBkYXRhc2V0OntcbiAgICAgICAgbmF2SWQ6IHN0cmluZyxcbiAgICAgICAgbmF2U2Nyb2xsSWQ6IHN0cmluZyxcbiAgICB9XG59XG5cblBhZ2Uoe1xuICAgIHNjcm9sbFN0YXRlczp7XG4gICAgICAgIG1haW5JdGVtOiBbXSBhcyBNYWluSXRlbVF1ZXJ5UmVzdWx0c1tdLFxuICAgIH0sXG4gICAgbGF5b3V0UmVzb2x2ZXI6dW5kZWZpbmVkIGFzICgodmFsdWU6IHVua25vd24pPT52b2lkKXx1bmRlZmluZWQsXG4gICAgLy9sYXlvdXRSZXNvbHZlcjoodmFsdWU6IHVua25vd24pID0+dm9pZCxcblxuICAgIGRhdGE6e1xuICAgICAgICBsaWNTdGF0dXM6IFByb2ZpbGVTdGF0dXNNYXAuZ2V0KHJlbnRhbC52MS5JZGVudGl0eVN0YXR1cy5VTlNVQk1JVFRFRCksXG4gICAgICAgIHRyaXBzSGVpZ2h0OjAsXG4gICAgICAgIGF2YXRhclVSTDonJyxcbiAgICAgICAgdHJpcHM6W10gYXMgVHJpcFtdLFxuICAgICAgICBtYWluaXRlbTogW10gYXMgTWFpbkl0ZW1bXSxcbiAgICAgICAgbmF2aXRlbTogW10gYXMgTmF2SXRtZVtdLFxuICAgICAgICBtYWluc2Nyb2xsOiAnJyxcbiAgICAgICAgbmF2Q291bnQ6MCxcbiAgICAgICAgbmF2U2VsZWN0OiAnJyxcbiAgICAgICAgbmF2U2Nyb2xsOlwieFwiLFxuICAgICAgICBwcm9tb3Rpb25JdGVtczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgaW1nOiAnaHR0cHM6Ly9pbWcxLmJhaWR1LmNvbS9pdC91PTU5MDExMDM0Niw0MzM3MDk3ODImZm09MjUzJmZtdD1hdXRvJmFwcD0xMzgmZj1KUEVHP3c9NTAwJmg9MjIyJyxcbiAgICAgICAgICAgIHByb21vdGlvbklkOjAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgaW1nOiAnaHR0cDovL2ltZy5tcC5pdGMuY24vdXBsb2FkLzIwMTYwNDIxL2ZhY2FhODJiNjdjMzQyYTc4ZGMyZTJmMWYyMGM2MzgxX3RoLmpwZycsXG4gICAgICAgICAgICBwcm9tb3Rpb25JZDogMSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICBpbWc6ICdodHRwczovL20xLmF1dG8uaXRjLmNuL2Nfem9vbSx3XzI3MC8yOTc2MjA5Ni5KUEcnLFxuICAgICAgICAgICAgcHJvbW90aW9uSWQ6IDMsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgaW1nOiAnaHR0cDovL3QxMy5iYWlkdS5jb20vaXQvdT0yNzkyODg0MjczLDE2ODE5OTIwMzQmZm09MjI0JmFwcD0xMTImZj1KUEVHP3c9NTAwJmg9MjUzJyxcbiAgICAgICAgICAgIHByb21vdGlvbklkOiA0LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgIGltZzogJ2h0dHBzOi8vZ2ltZzIuYmFpZHUuY29tL2ltYWdlX3NlYXJjaC9zcmM9aHR0cCUzQSUyRiUyRmRlZmF4aW5nemhlbmcuY29tJTJGUHVibGljJTJGdXBsb2FkcyUyRjViZWE4OTMzMzU0MDAuanBnJnJlZmVyPWh0dHAlM0ElMkYlMkZkZWZheGluZ3poZW5nLmNvbSZhcHA9MjAwMiZzaXplPWY5OTk5LDEwMDAwJnE9YTgwJm49MCZnPTBuJmZtdD1hdXRvP3NlYz0xNjUxNjcxNzA1JnQ9MmNkNTUzODk0MmJlY2JmNTMzNjViMjM4MDczMDBiZGMnLFxuICAgICAgICAgICAgcHJvbW90aW9uSWQ6IDUsXG4gICAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICAgICAgXG4gICAgfSxcbiAgICAgb25Mb2FkKCl7XG5cbiAgICAgICAgY29uc3QgbGF5b3V0UmVhZHkgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sYXlvdXRSZXNvbHZlciA9IHJlc29sdmVcbiAgICAgICAgfSlcbiAgICAgICAgUHJvbWlzZS5hbGwoW1RyaXBTZXJ2aWNlLmdldFRyaXBzKCksIGxheW91dFJlYWR5XSkudGhlbigoW3RyaXBzXSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJ0cmlwczpcIix0cmlwcylcbiAgICAgICAgICAgIHRoaXMucG9wdWxhdGVUcmlwcyh0cmlwcy50cmlwcyEpXG4gICAgICAgIH0pXG4gICAgICAgIGdldEFwcDxJQXBwT3B0aW9uPigpLmdsb2JhbERhdGEudXNlckluZm8udGhlbih1c2VySW5mbyA9PiB7XG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIGF2YXRhclVSTDogdXNlckluZm8uYXZhdGFyVXJsLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9LFxuXG4gICAgLy/lsZXnpLror6XpobXpnaLmiafooYxcbiAgICBvblNob3coKXtcbiAgICAgICAgUHJvZmlsZVNlcnZpY2UuZ2V0UHJvZmlsZSgpLnRoZW4ocCA9PntcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgbGljU3RhdHVzOiBQcm9maWxlU3RhdHVzTWFwLmdldChwLmlkZW50aXR5U3RhdHVzfHwwKSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIG9uUmVhZHkoKSB7XG4gICAgICAgIHd4LmNyZWF0ZVNlbGVjdG9yUXVlcnkoKS5zZWxlY3QoJyNoZWFkaW5nJylcbiAgICAgICAgICAgIC5ib3VuZGluZ0NsaWVudFJlY3QocmVjdCA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaGVpZ2h0ID0gd3guZ2V0U3lzdGVtSW5mb1N5bmMoKS53aW5kb3dIZWlnaHQgLSByZWN0LmhlaWdodFxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgICAgIHRyaXBzSGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgIG5hdkNvdW50OiBNYXRoLnJvdW5kKGhlaWdodC81MCksXG4gICAgICAgICAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sYXlvdXRSZXNvbHZlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXlvdXRSZXNvbHZlcihyZWN0KVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pLmV4ZWMoKVxuICAgIH0sXG5cbiAgICAvLyAgICAgbGV0IHRyaXBzID0gYXdhaXQgVHJpcFNlcnZpY2UuZ2V0VHJpcHMoKVxuICAgIC8vICAgICBjb25zb2xlLmxvZyhcIuihjOeoi+S/oeaBr1wiLHRyaXBzLnRyaXBzKVxuICAgIC8vICAgICB0aGlzLnBvcHVsYXRlVHJpcCh0cmlwcy50cmlwcyEpXG4gICAgLy8gICAgIGNvbnN0IHVzZXJJbmZvID0gYXdhaXQgZ2V0QXBwPElBcHBPcHRpb24+KCkuZ2xvYmFsRGF0YS51c2VySW5mb1xuICAgIC8vICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAvLyAgICAgICAgIGF2YXRhclVSTDogdXNlckluZm8uYXZhdGFyVXJsLFxuICAgIC8vICAgICB9KVxuICAgIC8vIH0sXG5cbiAgICBwb3B1bGF0ZVRyaXBzKHRyaXBzOiByZW50YWwudjEuSVRyaXBFbnRpdHlbXSl7XG4gICAgICAgIGNvbnN0IG1haW5JdGVtOiBNYWluSXRlbVtdID0gW11cbiAgICAgICAgY29uc3QgbmF2SXRlbTogTmF2SXRtZVtdID0gW11cbiAgICAgICAgbGV0IG5hdlNlbGVjdCA9ICcnXG4gICAgICAgIGxldCBwcmV2TmF2ID0gJydcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRyaXBzLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgICAgIGNvbnN0IHRyaXAgPSB0cmlwc1tpXVxuICAgICAgICAgICAgY29uc3QgbWFpbklkID0gJ21haW4tJyArIGkgXG4gICAgICAgICAgICBjb25zdCBuYXZJZCA9ICduYXYtJyArIGlcbiAgICAgICAgICAgIGNvbnN0IHNob3J0SWQgPSAgdHJpcC5pZD8uc3Vic3RyaW5nKHRyaXAuaWQubGVuZ3RoIC0gNikgIC8v5pi+56S65ZCONuS9jVxuICAgICAgICAgICAgaWYoIXByZXZOYXYpe1xuICAgICAgICAgICAgICAgIHByZXZOYXYgPSBuYXZJZFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBkdXJhdGlvbjogdHJpcC50cmlwPy5jdXJyZW50Py50aW1lc3RhbXBTZWMsXG4gICAgICAgICAgICAvLyAgICAgZmVlOiAnMjAw5YWDJyxcbiAgICAgICAgICAgIC8vICAgICBkaXN0YW5jZTogJzIwMEtNJyxcbiAgICAgICAgICAgIC8vICAgICBzdHV0YXI6ICfov5vooYzkuK0nLFxuXG4gICAgICAgICAgICAvL+WQkeWwhuaVsOaNruaLv+WHuuWMheijhVxuICAgICAgICAgICAgY29uc3QgdHJpcERhdGU6IFRyaXAgPSAge1xuICAgICAgICAgICAgICAgIGlkOiB0cmlwLmlkISxcbiAgICAgICAgICAgICAgICBzaG9ydElkOiAnKioqKionKyBzaG9ydElkLFxuICAgICAgICAgICAgICAgIHN0YXRhcjogdHJpcC50cmlwPy5zdGFydD8ucG9pTmFtZSB8fCAn5pyq55+lJyxcbiAgICAgICAgICAgICAgICBlbmQ6ICcnLFxuICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAnJyxcbiAgICAgICAgICAgICAgICBmZWU6ICcnLFxuICAgICAgICAgICAgICAgIGRpc3RhbmNlOiAnJyxcbiAgICAgICAgICAgICAgICBzdHV0YXI6IFRyaXBzU3RhdHVzTWFwLmdldCh0cmlwLnRyaXA/LnN0YXR1cyEpfHwn5pyq55+lJyxcbiAgICAgICAgICAgICAgICBpblByb2dyZXNzOiB0cmlwLnRyaXA/LnN0YXR1cyA9PT0gcmVudGFsLnYxLlRyaXBTdGF0dXMuSU5fUFJPR1JFU1MsXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8v57uT5p2f6KGM56iLXG4gICAgICAgICAgICBjb25zdCBlbmQgPSB0cmlwLnRyaXA/LmVuZFxuICAgICAgICAgICAgaWYgKGVuZCl7XG4gICAgICAgICAgICAgICAgdHJpcERhdGUuZW5kID0gZW5kLnBvaU5hbWV8fCfmnKrnn6UnXG4gICAgICAgICAgICAgICAgdHJpcERhdGUuZGlzdGFuY2UgPSBlbmQua21Ecml2ZW4/LnRvRml4ZWQoMSkrICflhazph4wnXG4gICAgICAgICAgICAgICAgdHJpcERhdGUuZmVlID0gZm9ybWF0ZmVlKGVuZC5mZWVDZW50fHwwKVxuICAgICAgICAgICAgICAgIGNvbnN0IGR1ciA9IGZvcm1hdER1cnRpb24oKGVuZC50aW1lc3RhbXBTZWN8fDApIC0gKHRyaXAudHJpcD8uc3RhcnQ/LnRpbWVzdGFtcFNlY3x8MCkpXG4gICAgICAgICAgICAgICAgdHJpcERhdGUuZHVyYXRpb24gPSBgJHtkdXIuaGh95pe2OiR7ZHVyLm1tfeWIhjoke2R1ci5zc33np5JgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvL+aUvuWFpVVJXG4gICAgICAgICAgICBtYWluSXRlbS5wdXNoKHtcbiAgICAgICAgICAgICAgICBpZDogbWFpbklkLFxuICAgICAgICAgICAgICAgIG5hdklkOiBuYXZJZCxcbiAgICAgICAgICAgICAgICBuYXZTY3JvbGxJZDpwcmV2TmF2LFxuICAgICAgICAgICAgICAgIGRhdGE6IHRyaXBEYXRlLFxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgbmF2SXRlbS5wdXNoKHtcbiAgICAgICAgICAgICAgICBpZDpuYXZJZCxcbiAgICAgICAgICAgICAgICBtYWluSWQ6IG1haW5JZCxcbiAgICAgICAgICAgICAgICBsYWJlbDogc2hvcnRJZHx8JycsXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgaWYoaSA9PT0gMCl7XG4gICAgICAgICAgICAgICAgbmF2U2VsZWN0ID0gbmF2SWRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHByZXZOYXYgPSBuYXZJZFxuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZGF0YS5uYXZDb3VudC04OyBpKyspIHtcbiAgICAgICAgICAgICAgICBuYXZJdGVtLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBpZDogJycsXG4gICAgICAgICAgICAgICAgICAgIG1haW5JZDogJycsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiAnJyxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBtYWluSXRlbSxcbiAgICAgICAgICAgIG5hdkl0ZW0sXG4gICAgICAgICAgICBuYXZTZWxlY3RcblxuICAgICAgICB9LCAoKSA9PntcbiAgICAgICAgICAgIHRoaXMucHJlcGFyZVNjcm9sbCgpXG4gICAgICAgIH0pXG4gICAgfSxcbiAgICAvL+S4jeaYr+W+iOaHglxuICAgIC8vIG9uUmVhZHkoKXtcbiAgICAvLyAgICAgd3guY3JlYXRlU2VsZWN0b3JRdWVyeSgpLnNlbGVjdCgnI2hlYWRpbmcnKVxuICAgIC8vICAgICAgICAgLmJvdW5kaW5nQ2xpZW50UmVjdChyZWN0ID0+e1xuICAgIC8vICAgICAgICAgICAgIGNvbnN0IGhlaWdodCA9IHd4LmdldFN5c3RlbUluZm9TeW5jKCkud2luZG93SGVpZ2h0IC0gcmVjdC5oZWlnaHRcbiAgICAvLyAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgIC8vICAgICAgICAgICAgICAgICB0cmlwc0hlaWdodDpoZWlnaHQsXG4gICAgLy8gICAgICAgICAgICAgICAgIG5hdkNvdW50OiBNYXRoLnJvdW5kKGhlaWdodC81MCksXG4gICAgLy8gICAgICAgICAgICAgfSlcbiAgICAvLyAgICAgICAgIH0pLmV4ZWMoKVxuICAgICAgICAgICAgXG4gICAgLy8gfSxcblxuICAgIGdldGNoYW5nZVBhZ2UoKXtcbiAgICAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICAgICAgICB1cmw6cm91dGluZy5yZWdpc3RlcigpLCAvL3JlZ2lzdGVyKCnkuLrlj6/pgInlj4LmlbBcbiAgICAgICAgfSlcbiAgICB9LFxuICAgIG9uR2V0VXNlckluZm8oZTogYW55KXtcbiAgICAgICAgY29uc29sZS5sb2coZSlcbiAgICAgICAgY29uc3QgdXNlckluZm86IFdlY2hhdE1pbmlwcm9ncmFtLlVzZXJJbmZvID0gZS5kZXRhaWwudXNlckluZm9cbiAgICAgICAgZ2V0QXBwPElBcHBPcHRpb24+KCkucmVzb2x2ZVVzZXJJbmZvKHVzZXJJbmZvKVxuICAgIH0sXG5cbiAgICBwcmVwYXJlU2Nyb2xsKCl7XG4gICAgICAgIHd4LmNyZWF0ZVNlbGVjdG9yUXVlcnkoKS5zZWxlY3RBbGwoJy5tYWluLWl0ZW0nKS5maWVsZHMoe1xuICAgICAgICAgICAgaWQ6IHRydWUsXG4gICAgICAgICAgICBkYXRhc2V0OiB0cnVlLFxuICAgICAgICAgICAgcmVjdDogdHJ1ZSxcbiAgICAgICAgfSkuZXhlYyhyZXMgPT57XG4gICAgICAgICAgICB0aGlzLnNjcm9sbFN0YXRlcy5tYWluSXRlbSA9IHJlc1swXVxuICAgICAgICB9KVxuXG4gICAgfSxcblxuICAgIG9uUHJvbW90aW9uSXRlbVRhcChlOiBhbnkpIHtcbiAgICAgICAgY29uc3QgcHJvbW90aW9uSUQ6bnVtYmVyID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQucHJvbW90aW9uSWRcbiAgICAgICAgaWYgKHByb21vdGlvbklEKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnY2xhaW1pbmcgcHJvbW90aW9uJywgcHJvbW90aW9uSUQpXG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgb25uYXZpdGVtVGFwKGU6IGFueSl7XG4gICAgICAgIC8v5pWw5o2u57uR5a6aXG4gICAgICAgIGNvbnN0IG1haW5JZDogc3RyaW5nID0gZS5jdXJyZW50VGFyZ2V0Py5kYXRhc2V0Lm1haW5JZFxuICAgICAgICAvL2NvbnN0IG5hdlNlbGVjdDpzdHJpbmcgPSBlLmN1cnJlbnRUYXJnZXQ/LmlkXG4gICAgICAgIGNvbnN0IG5hdklkOiBzdHJpbmcgPSBlLmN1cnJlbnRUYXJnZXQ/LmlkXG4gICAgICAgIGlmKG1haW5JZCAmJiBuYXZJZCl7XG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIG1haW5zY3JvbGw6IG1haW5JZCxcbiAgICAgICAgICAgICAgICBuYXZTZWxlY3Q6IG5hdklkLFxuICAgIFxuICAgICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBvbk1haW5TY3JvbGwoZTogYW55KXtcbiAgICAgICAgY29uc29sZS5sb2coZSlcbiAgICAgICAgY29uc3QgdG9wOiBudW1iZXIgPSBlLmN1cnJlbnRUYXJnZXQ/Lm9mZnNldFRvcCArIGUuZGV0YWlsPy5zY3JvbGxUb3BcbiAgICAgICAgaWYodG9wID09PSB1bmRlZmluZWQpe1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2VsSXRlbSA9IHRoaXMuc2Nyb2xsU3RhdGVzLm1haW5JdGVtLmZpbmQoSXRlbSA9PiBJdGVtLnRvcCA+PSB0b3ApXG4gICAgICAgIGlmKCFzZWxJdGVtKXtcbiAgICAgICAgICAgIHJldHVybiBcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgbmF2U2VsZWN0OiBzZWxJdGVtLmRhdGFzZXQubmF2SWQsXG4gICAgICAgICAgICBuYXZTY3JvbGw6IHNlbEl0ZW0uZGF0YXNldC5uYXZTY3JvbGxJZCxcblxuICAgICAgICAgICAgXG4gICAgICAgIH0pXG4gICAgICAgIFxuICAgIH0sXG5cbiAgICBvbk1pYW5JdGVtVGFwKGU6IGFueSkge1xuICAgICAgICBpZighZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQudHJpcEluUHJvZ3Jlc3Mpe1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCLmi7/kuI3liLA6XCIsZSlcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRyaXBJZCA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0LnRyaXBJZFxuICAgICAgICBpZih0cmlwSWQpe1xuICAgICAgICAgICAgY29uc29sZS5sb2codHJpcElkKVxuICAgICAgICAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICAgICAgICAgICAgdXJsOiByb3V0aW5nLmRyaXZpbmcoe1xuICAgICAgICAgICAgICAgICAgICB0cmlwX2lkOiB0cmlwSWQsXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgfVxufSlcbiJdfQ==